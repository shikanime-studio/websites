{"version":3,"file":"inject-plugin.js","sources":["../../src/inject-plugin.ts"],"sourcesContent":["import { readFileSync, writeFileSync } from 'node:fs'\nimport { gen, parse, t, trav } from './babel'\nimport type { PluginInjection } from '@tanstack/devtools-client'\nimport type { types as Babel } from '@babel/core'\nimport type { ParseResult } from '@babel/parser'\n\n/**\n * Detects if a file imports TanStack devtools packages\n * Handles: import X from '@tanstack/react-devtools'\n *          import * as X from '@tanstack/react-devtools'\n *          import { TanStackDevtools } from '@tanstack/react-devtools'\n */\nconst detectDevtoolsImport = (code: string): boolean => {\n  const devtoolsPackages = [\n    '@tanstack/react-devtools',\n    '@tanstack/solid-devtools',\n    '@tanstack/vue-devtools',\n    '@tanstack/svelte-devtools',\n    '@tanstack/angular-devtools',\n  ]\n\n  try {\n    const ast = parse(code, {\n      sourceType: 'module',\n      plugins: ['jsx', 'typescript'],\n    })\n\n    let hasDevtoolsImport = false\n\n    trav(ast, {\n      ImportDeclaration(path) {\n        const importSource = path.node.source.value\n        if (devtoolsPackages.includes(importSource)) {\n          hasDevtoolsImport = true\n          path.stop()\n        }\n      },\n    })\n\n    return hasDevtoolsImport\n  } catch (e) {\n    return false\n  }\n}\n\n/**\n * Finds the TanStackDevtools component name in the file\n * Handles renamed imports and namespace imports\n */\nexport const findDevtoolsComponentName = (\n  ast: ParseResult<Babel.File>,\n): string | null => {\n  let componentName: string | null = null\n  const devtoolsPackages = [\n    '@tanstack/react-devtools',\n    '@tanstack/solid-devtools',\n    '@tanstack/vue-devtools',\n    '@tanstack/svelte-devtools',\n    '@tanstack/angular-devtools',\n  ]\n\n  trav(ast, {\n    ImportDeclaration(path) {\n      const importSource = path.node.source.value\n      if (devtoolsPackages.includes(importSource)) {\n        // Check for: import { TanStackDevtools } from '@tanstack/...'\n        const namedImport = path.node.specifiers.find(\n          (spec) =>\n            t.isImportSpecifier(spec) &&\n            t.isIdentifier(spec.imported) &&\n            spec.imported.name === 'TanStackDevtools',\n        )\n        if (namedImport && t.isImportSpecifier(namedImport)) {\n          componentName = namedImport.local.name\n          path.stop()\n          return\n        }\n\n        // Check for: import * as DevtoolsName from '@tanstack/...'\n        const namespaceImport = path.node.specifiers.find((spec) =>\n          t.isImportNamespaceSpecifier(spec),\n        )\n        if (namespaceImport && t.isImportNamespaceSpecifier(namespaceImport)) {\n          // For namespace imports, we need to look for DevtoolsName.TanStackDevtools\n          componentName = `${namespaceImport.local.name}.TanStackDevtools`\n          path.stop()\n          return\n        }\n      }\n    },\n  })\n\n  return componentName\n}\n\nexport const transformAndInject = (\n  ast: ParseResult<Babel.File>,\n  injection: PluginInjection,\n  devtoolsComponentName: string,\n) => {\n  let didTransform = false\n\n  // Use pluginImport if provided, otherwise generate from package name\n  const importName = injection.pluginImport?.importName\n  const pluginType = injection.pluginImport?.type || 'jsx'\n  const displayName = injection.pluginName\n\n  if (!importName) {\n    return false\n  }\n  // Handle namespace imports like DevtoolsModule.TanStackDevtools\n  const isNamespaceImport = devtoolsComponentName.includes('.')\n\n  // Find and modify the TanStackDevtools JSX element\n  trav(ast, {\n    JSXOpeningElement(path) {\n      const elementName = path.node.name\n      let matches = false\n\n      if (isNamespaceImport) {\n        // Handle <DevtoolsModule.TanStackDevtools />\n        if (t.isJSXMemberExpression(elementName)) {\n          const fullName = `${t.isJSXIdentifier(elementName.object) ? elementName.object.name : ''}.${t.isJSXIdentifier(elementName.property) ? elementName.property.name : ''}`\n          matches = fullName === devtoolsComponentName\n        }\n      } else {\n        // Handle <TanStackDevtools /> or <RenamedDevtools />\n        matches =\n          t.isJSXIdentifier(elementName) &&\n          elementName.name === devtoolsComponentName\n      }\n\n      if (matches) {\n        // Find the plugins prop\n        const pluginsProp = path.node.attributes.find(\n          (attr) =>\n            t.isJSXAttribute(attr) &&\n            t.isJSXIdentifier(attr.name) &&\n            attr.name.name === 'plugins',\n        )\n        // plugins found\n        if (pluginsProp && t.isJSXAttribute(pluginsProp)) {\n          // Check if plugins prop has a value\n          if (\n            pluginsProp.value &&\n            t.isJSXExpressionContainer(pluginsProp.value)\n          ) {\n            const expression = pluginsProp.value.expression\n\n            // If it's an array expression, add our plugin to it\n            if (t.isArrayExpression(expression)) {\n              // Check if plugin already exists\n              const pluginExists = expression.elements.some((element) => {\n                if (!element) return false\n\n                // For function-based plugins, check if the function call exists\n                if (pluginType === 'function') {\n                  return (\n                    t.isCallExpression(element) &&\n                    t.isIdentifier(element.callee) &&\n                    element.callee.name === importName\n                  )\n                }\n\n                // For JSX plugins, check object with name property\n                if (!t.isObjectExpression(element)) return false\n\n                return element.properties.some((prop) => {\n                  if (\n                    !t.isObjectProperty(prop) ||\n                    !t.isIdentifier(prop.key) ||\n                    prop.key.name !== 'name'\n                  ) {\n                    return false\n                  }\n\n                  return (\n                    t.isStringLiteral(prop.value) &&\n                    prop.value.value === displayName\n                  )\n                })\n              })\n\n              if (!pluginExists) {\n                // For function-based plugins, add them directly as function calls\n                // For JSX plugins, wrap them in objects with name and render\n                if (pluginType === 'function') {\n                  // Add directly: FormDevtoolsPlugin()\n                  expression.elements.push(\n                    t.callExpression(t.identifier(importName), []),\n                  )\n                } else {\n                  // Add as object: { name: \"...\", render: <Component /> }\n                  const renderValue = t.jsxElement(\n                    t.jsxOpeningElement(t.jsxIdentifier(importName), [], true),\n                    null,\n                    [],\n                    true,\n                  )\n\n                  expression.elements.push(\n                    t.objectExpression([\n                      t.objectProperty(\n                        t.identifier('name'),\n                        t.stringLiteral(displayName),\n                      ),\n                      t.objectProperty(t.identifier('render'), renderValue),\n                    ]),\n                  )\n                }\n\n                didTransform = true\n              }\n            }\n          }\n        } else {\n          // No plugins prop exists, create one with our plugin\n          // For function-based plugins, add them directly as function calls\n          // For JSX plugins, wrap them in objects with name and render\n          let pluginElement\n          if (pluginType === 'function') {\n            // Add directly: plugins={[FormDevtoolsPlugin()]}\n            pluginElement = t.callExpression(t.identifier(importName), [])\n          } else {\n            // Add as object: plugins={[{ name: \"...\", render: <Component /> }]}\n            const renderValue = t.jsxElement(\n              t.jsxOpeningElement(t.jsxIdentifier(importName), [], true),\n              null,\n              [],\n              true,\n            )\n\n            pluginElement = t.objectExpression([\n              t.objectProperty(\n                t.identifier('name'),\n                t.stringLiteral(displayName),\n              ),\n              t.objectProperty(t.identifier('render'), renderValue),\n            ])\n          }\n\n          path.node.attributes.push(\n            t.jsxAttribute(\n              t.jsxIdentifier('plugins'),\n              t.jsxExpressionContainer(t.arrayExpression([pluginElement])),\n            ),\n          )\n\n          didTransform = true\n        }\n      }\n    },\n  })\n\n  // Add import at the top of the file if transform happened\n  // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n  if (didTransform) {\n    const importDeclaration = t.importDeclaration(\n      [t.importSpecifier(t.identifier(importName), t.identifier(importName))],\n      t.stringLiteral(injection.packageName),\n    )\n\n    // Find the last import declaration\n    let lastImportIndex = -1\n    ast.program.body.forEach((node, index) => {\n      if (t.isImportDeclaration(node)) {\n        lastImportIndex = index\n      }\n    })\n\n    // Insert after the last import or at the beginning\n    ast.program.body.splice(lastImportIndex + 1, 0, importDeclaration)\n  }\n\n  return didTransform\n}\n\n/**\n * Detects if a file contains TanStack devtools import\n */\nexport function detectDevtoolsFile(code: string): boolean {\n  return detectDevtoolsImport(code)\n}\n\n/**\n * Injects a plugin into the TanStackDevtools component in a file\n * Reads the file, transforms it, and writes it back\n */\nexport function injectPluginIntoFile(\n  filePath: string,\n  injection: PluginInjection,\n): { success: boolean; error?: string } {\n  try {\n    // Read the file\n    const code = readFileSync(filePath, 'utf-8')\n\n    // Parse the code\n    const ast = parse(code, {\n      sourceType: 'module',\n      plugins: ['jsx', 'typescript'],\n    })\n\n    // Find the devtools component name (handles renamed imports)\n    const devtoolsComponentName = findDevtoolsComponentName(ast)\n    if (!devtoolsComponentName) {\n      return {\n        success: false,\n        error: 'Could not find TanStackDevtools import',\n      }\n    }\n\n    // Transform and inject\n    const didTransform = transformAndInject(\n      ast,\n      injection,\n      devtoolsComponentName,\n    )\n\n    if (!didTransform) {\n      return {\n        success: false,\n        error: 'Plugin already exists or no TanStackDevtools component found',\n      }\n    }\n\n    // Generate the new code\n    const result = gen(ast, {\n      sourceMaps: false,\n      retainLines: false,\n    })\n\n    // Write back to file\n    writeFileSync(filePath, result.code, 'utf-8')\n\n    return { success: true }\n  } catch (e) {\n    console.error('Error injecting plugin:', e)\n    return {\n      success: false,\n      error: e instanceof Error ? e.message : 'Unknown error',\n    }\n  }\n}\n"],"names":[],"mappings":"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"}