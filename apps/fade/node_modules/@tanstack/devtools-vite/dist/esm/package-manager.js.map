{"version":3,"file":"package-manager.js","sources":["../../src/package-manager.ts"],"sourcesContent":["import { exec } from 'node:child_process'\nimport { existsSync } from 'node:fs'\nimport { join } from 'node:path'\nimport { devtoolsEventClient } from '@tanstack/devtools-client'\nimport chalk from 'chalk'\nimport { readPackageJson, tryParseJson } from './utils'\nimport { injectPluginIntoFile } from './inject-plugin'\nimport type { OutdatedDeps } from '@tanstack/devtools-client'\n\n/**\n * Gets the outdated command for the detected package manager\n */\nconst getOutdatedCommand = (packageManager: string): string => {\n  switch (packageManager) {\n    case 'yarn':\n      return 'yarn outdated --json'\n    case 'pnpm':\n      return 'pnpm outdated --format json'\n    case 'bun':\n      return 'bun outdated --json'\n    case 'npm':\n    default:\n      return 'npm outdated --json'\n  }\n}\n\n/**\n * Adds a plugin to the devtools configuration file\n */\nexport const addPluginToDevtools = (\n  devtoolsFileId: string | null,\n  packageName: string,\n  pluginName: string,\n  pluginImport?: { importName: string; type: 'jsx' | 'function' },\n): { success: boolean; error?: string } => {\n  // Check if we found the devtools file\n  if (!devtoolsFileId) {\n    const error = 'Devtools file not found'\n    console.log(\n      chalk.yellowBright(\n        `[@tanstack/devtools-vite] Could not add plugin. ${error}.`,\n      ),\n    )\n    return { success: false, error }\n  }\n\n  // Inject the plugin into the file\n  const result = injectPluginIntoFile(devtoolsFileId, {\n    packageName,\n    pluginName,\n    pluginImport,\n  })\n\n  if (result.success) {\n    console.log(\n      chalk.greenBright(\n        `[@tanstack/devtools-vite] Successfully added ${packageName} to devtools!`,\n      ),\n    )\n  } else {\n    console.log(\n      chalk.yellowBright(\n        `[@tanstack/devtools-vite] Could not add plugin: ${result.error}`,\n      ),\n    )\n  }\n\n  return result\n}\n/**\n * Gets the install command for the detected package manager\n */\nconst getInstallCommand = (\n  packageManager: string,\n  packageName: string,\n): string => {\n  switch (packageManager) {\n    case 'yarn':\n      return `yarn add -D ${packageName}`\n    case 'pnpm':\n      return `pnpm add -D ${packageName}`\n    case 'bun':\n      return `bun add -D ${packageName}`\n    case 'npm':\n    default:\n      return `npm install -D ${packageName}`\n  }\n}\n\nexport const installPackage = async (\n  packageName: string,\n): Promise<{\n  success: boolean\n  error?: string\n}> => {\n  return new Promise((resolve) => {\n    const packageManager = detectPackageManager()\n    const installCommand = getInstallCommand(packageManager, packageName)\n\n    console.log(\n      chalk.blueBright(\n        `[@tanstack/devtools-vite] Installing ${packageName}...`,\n      ),\n    )\n\n    exec(installCommand, async (installError) => {\n      if (installError) {\n        console.error(\n          chalk.redBright(\n            `[@tanstack/devtools-vite] Failed to install ${packageName}:`,\n          ),\n          installError.message,\n        )\n        resolve({\n          success: false,\n          error: installError.message,\n        })\n        return\n      }\n\n      console.log(\n        chalk.greenBright(\n          `[@tanstack/devtools-vite] Successfully installed ${packageName}`,\n        ),\n      )\n\n      // Read the updated package.json and emit the event\n      const updatedPackageJson = await readPackageJson()\n      devtoolsEventClient.emit('package-json-updated', {\n        packageJson: updatedPackageJson,\n      })\n\n      resolve({ success: true })\n    })\n  })\n}\n\n/**\n * Detects the package manager used in the project by checking for lock files\n */\nconst detectPackageManager = (): 'npm' | 'yarn' | 'pnpm' | 'bun' => {\n  const cwd = process.cwd()\n\n  // Check for lock files in order of specificity\n  if (existsSync(join(cwd, 'bun.lockb')) || existsSync(join(cwd, 'bun.lock'))) {\n    return 'bun'\n  }\n  if (existsSync(join(cwd, 'pnpm-lock.yaml'))) {\n    return 'pnpm'\n  }\n  if (existsSync(join(cwd, 'yarn.lock'))) {\n    return 'yarn'\n  }\n  if (existsSync(join(cwd, 'package-lock.json'))) {\n    return 'npm'\n  }\n\n  // Default to pnpm if no lock file is found\n  return 'pnpm'\n}\n\nexport const emitOutdatedDeps = async () => {\n  return await new Promise<OutdatedDeps | null>((resolve) => {\n    const packageManager = detectPackageManager()\n    const outdatedCommand = getOutdatedCommand(packageManager)\n\n    exec(outdatedCommand, (_, stdout) => {\n      // outdated commands exit with code 1 if there are outdated packages, but still output valid JSON\n      if (stdout) {\n        const newOutdatedDeps = tryParseJson<OutdatedDeps>(stdout)\n        if (!newOutdatedDeps) {\n          return\n        }\n        devtoolsEventClient.emit('outdated-deps-read', {\n          outdatedDeps: newOutdatedDeps,\n        })\n        resolve(newOutdatedDeps)\n      }\n    })\n  })\n}\n"],"names":[],"mappings":"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"}