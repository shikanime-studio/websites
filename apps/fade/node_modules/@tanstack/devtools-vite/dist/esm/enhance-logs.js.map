{"version":3,"file":"enhance-logs.js","sources":["../../src/enhance-logs.ts"],"sourcesContent":["import chalk from 'chalk'\nimport { normalizePath } from 'vite'\nimport { gen, parse, t, trav } from './babel'\nimport type { types as Babel } from '@babel/core'\nimport type { ParseResult } from '@babel/parser'\n\nconst transform = (\n  ast: ParseResult<Babel.File>,\n  filePath: string,\n  port: number,\n) => {\n  let didTransform = false\n\n  trav(ast, {\n    CallExpression(path) {\n      const callee = path.node.callee\n      // Match console.log(...) or console.error(...)\n      if (\n        callee.type === 'MemberExpression' &&\n        callee.object.type === 'Identifier' &&\n        callee.object.name === 'console' &&\n        callee.property.type === 'Identifier' &&\n        (callee.property.name === 'log' || callee.property.name === 'error')\n      ) {\n        const location = path.node.loc\n        if (!location) {\n          return\n        }\n        const [lineNumber, column] = [\n          location.start.line,\n          location.start.column,\n        ]\n        const finalPath = `${filePath}:${lineNumber}:${column + 1}`\n        path.node.arguments.unshift(\n          t.stringLiteral(\n            `${chalk.magenta('LOG')} ${chalk.blueBright(`${finalPath} - http://localhost:${port}/__tsd/open-source?source=${encodeURIComponent(finalPath)}`)}\\n â†’ `,\n          ),\n        )\n        didTransform = true\n      }\n    },\n  })\n\n  return didTransform\n}\n\nexport function enhanceConsoleLog(code: string, id: string, port: number) {\n  const [filePath] = id.split('?')\n  // eslint-disable-next-line @typescript-eslint/no-non-null-asserted-optional-chain\n  const location = filePath?.replace(normalizePath(process.cwd()), '')!\n\n  try {\n    const ast = parse(code, {\n      sourceType: 'module',\n      plugins: ['jsx', 'typescript'],\n    })\n    const didTransform = transform(ast, location, port)\n    if (!didTransform) {\n      return\n    }\n    return gen(ast, {\n      sourceMaps: true,\n      retainLines: true,\n      filename: id,\n      sourceFileName: filePath,\n    })\n  } catch (e) {\n    return\n  }\n}\n"],"names":[],"mappings":";;;;;AAMA,MAAM,YAAY,CAChB,KACA,UACA,SACG;AACH,MAAI,eAAe;AAEnB,OAAK,KAAK;AAAA,IACR,eAAe,MAAM;AACnB,YAAM,SAAS,KAAK,KAAK;AAEzB,UACE,OAAO,SAAS,sBAChB,OAAO,OAAO,SAAS,gBACvB,OAAO,OAAO,SAAS,aACvB,OAAO,SAAS,SAAS,iBACxB,OAAO,SAAS,SAAS,SAAS,OAAO,SAAS,SAAS,UAC5D;AACA,cAAM,WAAW,KAAK,KAAK;AAC3B,YAAI,CAAC,UAAU;AACb;AAAA,QACF;AACA,cAAM,CAAC,YAAY,MAAM,IAAI;AAAA,UAC3B,SAAS,MAAM;AAAA,UACf,SAAS,MAAM;AAAA,QAAA;AAEjB,cAAM,YAAY,GAAG,QAAQ,IAAI,UAAU,IAAI,SAAS,CAAC;AACzD,aAAK,KAAK,UAAU;AAAA,UAClB,EAAE;AAAA,YACA,GAAG,MAAM,QAAQ,KAAK,CAAC,IAAI,MAAM,WAAW,GAAG,SAAS,uBAAuB,IAAI,6BAA6B,mBAAmB,SAAS,CAAC,EAAE,CAAC;AAAA;AAAA,UAAA;AAAA,QAClJ;AAEF,uBAAe;AAAA,MACjB;AAAA,IACF;AAAA,EAAA,CACD;AAED,SAAO;AACT;AAEO,SAAS,kBAAkB,MAAc,IAAY,MAAc;AACxE,QAAM,CAAC,QAAQ,IAAI,GAAG,MAAM,GAAG;AAE/B,QAAM,WAAW,UAAU,QAAQ,cAAc,QAAQ,IAAA,CAAK,GAAG,EAAE;AAEnE,MAAI;AACF,UAAM,MAAM,MAAM,MAAM;AAAA,MACtB,YAAY;AAAA,MACZ,SAAS,CAAC,OAAO,YAAY;AAAA,IAAA,CAC9B;AACD,UAAM,eAAe,UAAU,KAAK,UAAU,IAAI;AAClD,QAAI,CAAC,cAAc;AACjB;AAAA,IACF;AACA,WAAO,IAAI,KAAK;AAAA,MACd,YAAY;AAAA,MACZ,aAAa;AAAA,MACb,UAAU;AAAA,MACV,gBAAgB;AAAA,IAAA,CACjB;AAAA,EACH,SAAS,GAAG;AACV;AAAA,EACF;AACF;"}