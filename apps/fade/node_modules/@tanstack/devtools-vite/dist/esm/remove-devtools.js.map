{"version":3,"file":"remove-devtools.js","sources":["../../src/remove-devtools.ts"],"sourcesContent":["import { gen, parse, trav } from './babel'\nimport type { t } from './babel'\nimport type { types as Babel, NodePath } from '@babel/core'\nimport type { ParseResult } from '@babel/parser'\n\nconst isTanStackDevtoolsImport = (source: string) =>\n  source === '@tanstack/react-devtools' ||\n  source === '@tanstack/devtools' ||\n  source === '@tanstack/solid-devtools'\n\nconst getImportedNames = (importDecl: t.ImportDeclaration) => {\n  return importDecl.specifiers.map((spec) => spec.local.name)\n}\n\nconst getLeftoverImports = (node: NodePath<t.JSXElement>) => {\n  const finalReferences: Array<string> = []\n  node.traverse({\n    JSXAttribute(path) {\n      const node = path.node\n      const propName =\n        typeof node.name.name === 'string'\n          ? node.name.name\n          : node.name.name.name\n\n      if (\n        propName === 'plugins' &&\n        node.value?.type === 'JSXExpressionContainer' &&\n        node.value.expression.type === 'ArrayExpression'\n      ) {\n        const elements = node.value.expression.elements\n\n        elements.forEach((el) => {\n          if (el?.type === 'ObjectExpression') {\n            // { name: \"something\", render: ()=> <Component /> }\n            const props = el.properties\n            const referencesToRemove = props\n              .map((prop) => {\n                if (\n                  prop.type === 'ObjectProperty' &&\n                  prop.key.type === 'Identifier' &&\n                  prop.key.name === 'render'\n                ) {\n                  const value = prop.value\n                  // handle <ReactRouterPanel />\n                  if (\n                    value.type === 'JSXElement' &&\n                    value.openingElement.name.type === 'JSXIdentifier'\n                  ) {\n                    const elementName = value.openingElement.name.name\n                    return elementName\n                  }\n                  // handle () => <ReactRouterPanel /> or function() { return <ReactRouterPanel /> }\n                  if (\n                    value.type === 'ArrowFunctionExpression' ||\n                    value.type === 'FunctionExpression'\n                  ) {\n                    const body = value.body\n                    if (\n                      body.type === 'JSXElement' &&\n                      body.openingElement.name.type === 'JSXIdentifier'\n                    ) {\n                      const elementName = body.openingElement.name.name\n                      return elementName\n                    }\n                  }\n                  // handle render: SomeComponent\n                  if (value.type === 'Identifier') {\n                    const elementName = value.name\n                    return elementName\n                  }\n\n                  // handle render: someFunction()\n                  if (\n                    value.type === 'CallExpression' &&\n                    value.callee.type === 'Identifier'\n                  ) {\n                    const elementName = value.callee.name\n                    return elementName\n                  }\n\n                  return ''\n                }\n                return ''\n              })\n              .filter(Boolean)\n            finalReferences.push(...referencesToRemove)\n          }\n        })\n      }\n    },\n  })\n  return finalReferences\n}\n\nconst transform = (ast: ParseResult<Babel.File>) => {\n  let didTransform = false\n  const devtoolsComponentNames = new Set()\n  const finalReferences: Array<string> = []\n\n  const transformations: Array<() => void> = []\n\n  trav(ast, {\n    ImportDeclaration(path) {\n      const importSource = path.node.source.value\n      if (isTanStackDevtoolsImport(importSource)) {\n        getImportedNames(path.node).forEach((name) =>\n          devtoolsComponentNames.add(name),\n        )\n\n        transformations.push(() => {\n          path.remove()\n        })\n\n        didTransform = true\n      }\n    },\n    JSXElement(path) {\n      const opening = path.node.openingElement\n      if (\n        opening.name.type === 'JSXIdentifier' &&\n        devtoolsComponentNames.has(opening.name.name)\n      ) {\n        const refs = getLeftoverImports(path)\n\n        finalReferences.push(...refs)\n        transformations.push(() => {\n          path.remove()\n        })\n        didTransform = true\n      }\n      if (\n        opening.name.type === 'JSXMemberExpression' &&\n        opening.name.object.type === 'JSXIdentifier' &&\n        devtoolsComponentNames.has(opening.name.object.name)\n      ) {\n        const refs = getLeftoverImports(path)\n        finalReferences.push(...refs)\n        transformations.push(() => {\n          path.remove()\n        })\n        didTransform = true\n      }\n    },\n  })\n\n  trav(ast, {\n    ImportDeclaration(path) {\n      const imports = path.node.specifiers\n      for (const imported of imports) {\n        if (imported.type === 'ImportSpecifier') {\n          if (finalReferences.includes(imported.local.name)) {\n            transformations.push(() => {\n              // remove the specifier\n              path.node.specifiers = path.node.specifiers.filter(\n                (spec) => spec !== imported,\n              )\n              // remove whole import if nothing is left\n              if (path.node.specifiers.length === 0) {\n                path.remove()\n              }\n            })\n          }\n        }\n      }\n    },\n  })\n\n  transformations.forEach((fn) => fn())\n\n  return didTransform\n}\n\nexport function removeDevtools(code: string, id: string) {\n  const [filePath] = id.split('?')\n\n  try {\n    const ast = parse(code, {\n      sourceType: 'module',\n      plugins: ['jsx', 'typescript'],\n    })\n    const didTransform = transform(ast)\n    if (!didTransform) {\n      return\n    }\n    return gen(ast, {\n      sourceMaps: true,\n      retainLines: true,\n      filename: id,\n      sourceFileName: filePath,\n    })\n  } catch (e) {\n    return\n  }\n}\n"],"names":["node"],"mappings":"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"}