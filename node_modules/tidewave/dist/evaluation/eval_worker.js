// src/evaluation/eval_worker.ts
process.on("message", async (message) => {
  if (!process.send) {
    console.error("[Tidewave] Unable to establish communication channel with code-executor.");
    process.exit(1);
  }
  if (message.type === "evaluate") {
    const { code, args } = message.request;
    try {
      const AsyncFunction = Object.getPrototypeOf(async () => {}).constructor;
      const fn = new AsyncFunction(code);
      const result = await fn(...args);
      process.send({
        type: "result",
        success: true,
        data: (result ?? null) && result
      });
    } catch (error) {
      process.send({
        type: "result",
        success: false,
        data: new String(error)
      });
    }
  } else if (message.type === "finish") {
    process.exit(0);
  }
});
