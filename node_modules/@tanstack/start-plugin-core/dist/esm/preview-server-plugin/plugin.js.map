{"version":3,"file":"plugin.js","sources":["../../../src/preview-server-plugin/plugin.ts"],"sourcesContent":["import { pathToFileURL } from 'node:url'\nimport { basename, extname, join } from 'pathe'\nimport { NodeRequest, sendNodeResponse } from 'srvx/node'\nimport { joinURL } from 'ufo'\nimport { VITE_ENVIRONMENT_NAMES } from '../constants'\nimport { getServerOutputDirectory } from '../output-directory'\nimport type { Plugin } from 'vite'\n\nexport function previewServerPlugin(): Plugin {\n  return {\n    name: 'tanstack-start-core:preview-server',\n    configurePreviewServer: {\n      // Run last so platform plugins (Cloudflare, Vercel, etc.) can register their handlers first\n      order: 'post',\n      handler(server) {\n        // Return a function so Vite's internal middlewares (static files, etc.) handle requests first.\n        // Our SSR handler only processes requests that nothing else handled.\n        return () => {\n          // Cache the server build to avoid re-importing on every request\n          let serverBuild: any = null\n\n          server.middlewares.use(async (req, res, next) => {\n            try {\n              // Lazy load server build on first request\n              if (!serverBuild) {\n                // Derive output filename from input\n                const serverEnv =\n                  server.config.environments[VITE_ENVIRONMENT_NAMES.server]\n                const serverInput =\n                  serverEnv?.build.rollupOptions.input ?? 'server'\n\n                if (typeof serverInput !== 'string') {\n                  throw new Error('Invalid server input. Expected a string.')\n                }\n\n                // Get basename without extension and add .js\n                const outputFilename = `${basename(serverInput, extname(serverInput))}.js`\n                const serverOutputDir = getServerOutputDirectory(server.config)\n                const serverEntryPath = join(serverOutputDir, outputFilename)\n                const imported = await import(\n                  pathToFileURL(serverEntryPath).toString()\n                )\n\n                serverBuild = imported.default\n              }\n\n              // Prepend base path to request URL to match routing setup\n              req.url = joinURL(server.config.base, req.url ?? '/')\n\n              const webReq = new NodeRequest({ req, res })\n              const webRes: Response = await serverBuild.fetch(webReq)\n\n              // Temporary workaround\n              // Vite preview's compression middleware doesn't support flattened array headers that srvx sets\n              // Call writeHead() before srvx to avoid corruption\n              res.setHeaders(webRes.headers)\n              res.writeHead(webRes.status, webRes.statusText)\n\n              return sendNodeResponse(res, webRes)\n            } catch (error) {\n              next(error)\n            }\n          })\n        }\n      },\n    },\n  }\n}\n"],"names":[],"mappings":";;;;;;AAQO,SAAS,sBAA8B;AAC5C,SAAO;AAAA,IACL,MAAM;AAAA,IACN,wBAAwB;AAAA;AAAA,MAEtB,OAAO;AAAA,MACP,QAAQ,QAAQ;AAGd,eAAO,MAAM;AAEX,cAAI,cAAmB;AAEvB,iBAAO,YAAY,IAAI,OAAO,KAAK,KAAK,SAAS;AAC/C,gBAAI;AAEF,kBAAI,CAAC,aAAa;AAEhB,sBAAM,YACJ,OAAO,OAAO,aAAa,uBAAuB,MAAM;AAC1D,sBAAM,cACJ,WAAW,MAAM,cAAc,SAAS;AAE1C,oBAAI,OAAO,gBAAgB,UAAU;AACnC,wBAAM,IAAI,MAAM,0CAA0C;AAAA,gBAC5D;AAGA,sBAAM,iBAAiB,GAAG,SAAS,aAAa,QAAQ,WAAW,CAAC,CAAC;AACrE,sBAAM,kBAAkB,yBAAyB,OAAO,MAAM;AAC9D,sBAAM,kBAAkB,KAAK,iBAAiB,cAAc;AAC5D,sBAAM,WAAW,MAAM,OACrB,cAAc,eAAe,EAAE,SAAA;AAGjC,8BAAc,SAAS;AAAA,cACzB;AAGA,kBAAI,MAAM,QAAQ,OAAO,OAAO,MAAM,IAAI,OAAO,GAAG;AAEpD,oBAAM,SAAS,IAAI,YAAY,EAAE,KAAK,KAAK;AAC3C,oBAAM,SAAmB,MAAM,YAAY,MAAM,MAAM;AAKvD,kBAAI,WAAW,OAAO,OAAO;AAC7B,kBAAI,UAAU,OAAO,QAAQ,OAAO,UAAU;AAE9C,qBAAO,iBAAiB,KAAK,MAAM;AAAA,YACrC,SAAS,OAAO;AACd,mBAAK,KAAK;AAAA,YACZ;AAAA,UACF,CAAC;AAAA,QACH;AAAA,MACF;AAAA,IAAA;AAAA,EACF;AAEJ;"}