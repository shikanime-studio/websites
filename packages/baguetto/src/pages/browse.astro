---
import FluidLayout from "../layouts/FluidLayout.astro";
import { Gallery } from "../components/Gallery";
import { PageTabs } from "../components/PageTabs";
import { FilterBar } from "../components/FilterBar";
import type { CardProps } from "../components/Card";
import { createD1Database } from "../lib/db";
import { getItemsWithMakers, getAllMakers, getAllEvents, getAllCharacters } from "../lib/items";

const db = createD1Database(Astro.locals);
const type = Astro.url.searchParams.get('type') || 'merchs';

let galleryItems: CardProps[] = [];
let categories: string[] = [];
let activeTab = type;

// Fetch data based on type
switch (type) {
  case 'artists':
    const makers = await getAllMakers(db);
    galleryItems = makers.map(maker => ({
      id: maker.id,
      title: maker.name,
      images: maker.avatarImageUrl ? [maker.avatarImageUrl] : [`https://placehold.co/600x400/ffe4e6/be123c?text=${encodeURIComponent(maker.name)}`],
      artist: {
        name: maker.name,
        avatar: maker.avatarImageUrl || '',
        verified: true,
      },
      rating: 5.0,
      reviewCount: Math.floor(Math.random() * 50) + 1,
      status: "OPEN",
      href: `/artists/${maker.id}` // We might want to keep individual profile pages or route them differently
    }));
    categories = ['Digital Art', 'Traditional Art', 'Merchandise', 'Commissions'];
    break;

  case 'events':
    const events = await getAllEvents(db);
    galleryItems = events.map(event => ({
      id: event.id,
      title: event.name,
      images: event.imageUrl ? [event.imageUrl] : [`https://placehold.co/600x400/ffe4e6/be123c?text=${encodeURIComponent(event.name)}`],
      artist: {
        name: event.location || 'Online',
        avatar: '',
        verified: true,
      },
      rating: 5.0,
      reviewCount: Math.floor(Math.random() * 100) + 10,
      status: "OPEN",
      price: new Date(event.startsAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }),
      href: `/events/${event.id}`
    }));
    categories = ['Conventions', 'Pop-up Shops', 'Artist Alleys', 'Online Events'];
    break;

  case 'characters':
    const characters = await getAllCharacters(db);
    galleryItems = characters.map(char => ({
      id: char.id,
      title: char.name,
      images: char.imageUrl ? [char.imageUrl] : [`https://placehold.co/600x400/ffe4e6/be123c?text=${encodeURIComponent(char.name)}`],
      artist: {
        name: 'Original Character', // Default since we don't have source info
        avatar: '',
        verified: true,
      },
      rating: 5.0,
      reviewCount: Math.floor(Math.random() * 200) + 10,
      status: "OPEN",
      price: undefined,
      href: `/characters/${char.id}`
    }));
    categories = ['Anime', 'Games', 'Manga', 'Original'];
    break;

  case 'merchs':
  default:
    const items = await getItemsWithMakers(db);
    galleryItems = items.map(item => ({
      id: item.id,
      title: item.name,
      images: item.imageUrls || [],
      artist: {
        name: item.maker?.name || 'Unknown',
        avatar: item.maker?.avatarImageUrl || '',
      },
      rating: 5,
      reviewCount: 12,
      status: "OPEN",
      price: item.priceRange || undefined,
      href: `/items/${item.id}`
    }));
    categories = ['Stickers', 'Prints', 'Mugs', 'Keychains', 'Apparel', 'Accessories'];
    break;
}
---

<FluidLayout>
  <div class="container mx-auto px-4 py-6">
    <PageTabs activeTab={activeTab} client:load />

    <div class="mb-8">
      <FilterBar categories={categories} client:load />
    </div>

    <Gallery items={galleryItems} client:load />
  </div>
</FluidLayout>
