---
import "@fontsource-variable/inter";
import Footer from "../components/Footer.astro";
import Navbar from "../components/Navbar.astro";
import { getSessionForHome } from "../lib/session";
import { getD1Database } from "../lib/util";

const db = getD1Database(Astro.locals);

let session: Awaited<ReturnType<typeof getSessionForHome>> | undefined;
let error: string | undefined;
const sessionId = Astro.cookies.get("session");
if (sessionId) {
  try {
    session = await getSessionForHome(db, sessionId.value);
  } catch (e) {
    if (e instanceof Error && e.message === "No session") {
      error = "Unexpected error while loading session";
    }
  }
}
---

<Navbar session={session} />
<slot />
<Footer />
{
  error && (
    <div class="toast toast-center">
      <div role="alert" class="alert alert-error">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6 shrink-0 stroke-current"
          fill="none"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <span>{error}</span>
      </div>
    </div>
  )
}
